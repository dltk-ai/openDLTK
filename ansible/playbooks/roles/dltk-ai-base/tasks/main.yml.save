---
# tasks file for base

- name: go to folder and register user name
  shell: whoami
  args:
    chdir: /home/
  register: username

- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: /home/{{ username.stdout }}/dltk-ai
    state: directory
    mode: '0755'

- name: Git checkout
  ansible.builtin.git:
    repo: 'https://github.com/dltk-ai/openDLTK_beta.git'
    dest: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta
    version: main

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/docker-compose.yml
    line: "REGISTRY_SERVICE_IP"
    state: present
  check_mode: yes
  register: presence

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/.env
    regexp: '- '
    line: REGISTRY_SERVICE_IP={{  solution_instance_ip  }}
  when: presence is changed

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/docker-compose.yml
    line: "KONG_URL"
    state: present
  check_mode: yes
  register: presence

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/.env
    regexp: '- '
    line: KONG_URL=http://{{  solution_instance_ip  }}:8000
  when: presence is changed

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/docker-compose.yml
    line: "KONG_ADMIN_URL"
    state: present
  check_mode: yes
  register: presence

- lineinfile:
    path: /home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/.env
    regexp: '- '
    line: KONG_ADMIN_URL=http://{{  solution_instance_ip  }}:8001
  when: presence is changed


- name: run docker-compose.yml file
  command: chdir=/home/{{ username.stdout }}/dltk-ai/openDLTK_beta/base/ docker-compose up -d

